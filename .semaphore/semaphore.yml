version: v1.0
name: UVT VM Testing Pipeline (ARM64)
agent:
  machine:
    type: a1-standard-4  # ARM64 machine type
    os_image: ubuntu2004-arm64

blocks:
  - name: "UVT User 2404 ARM64"
    task:
      env_vars:
        - name: SSH_OPTS
          value: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
      
      prologue:
        commands:
          # Checkout code
          - checkout
          
          # Initialize submodules
          - git submodule update --init --recursive
          
          # Install uvtool
          - sudo apt-get update
          - sudo apt-get install -y uvtool
          
          # Sync Ubuntu Noble image for ARM64
          - sudo uvt-simplestreams-libvirt -v sync release=noble arch=arm64
          
          # Create SSH key if not exists
          - sudo test -f /root/.ssh/id_rsa || sudo ssh-keygen -t rsa -b 2048 -f /root/.ssh/id_rsa -N ""
      
      jobs:
        - name: Run UVT VM Tests on ARM64
          commands:
            # Destroy existing VM if exists (cleanup from potential previous runs)
            - sudo uvt-kvm destroy uvt-user-2404 || true
            
            # Create VM with ARM64 architecture
            - sudo uvt-kvm create uvt-user-2404 release=noble arch=arm64 --memory 4096 --disk 10
            
            # Wait for VM to be ready
            - sudo uvt-kvm wait uvt-user-2404
            
            # Get VM IP and store it
            - "export VM_IP=$(sudo uvt-kvm ip uvt-user-2404) && echo \"VM IP: $VM_IP\""
            
            # Sync files to VM
            - "sudo rsync -avz --delete -e \"ssh $SSH_OPTS\" ./ ubuntu@$(sudo uvt-kvm ip uvt-user-2404):/home/ubuntu/ansible-playbooks/"
            
            # Clean and prepare manual directory
            - sudo uvt-kvm ssh uvt-user-2404 -- "cd ansible-playbooks && rm -rf manual"
            - sudo uvt-kvm ssh uvt-user-2404 -- "cd ansible-playbooks && mkdir manual"
            
            # Generate common.yml
            - sudo uvt-kvm ssh uvt-user-2404 -- "cd ansible-playbooks && sed 's/# //g' roles/user/defaults/main.yml > manual/common.yml"
            
            # Run bootstrap script
            - sudo uvt-kvm ssh uvt-user-2404 -- "cd ansible-playbooks && ./bootstrap.sh user.yml LOCAL"
            
            # Update and upgrade packages
            - sudo uvt-kvm ssh uvt-user-2404 -- "sudo apt-get update"
            - sudo uvt-kvm ssh uvt-user-2404 -- "sudo apt-get -y upgrade"
            - sudo uvt-kvm ssh uvt-user-2404 -- "sudo apt-get -y dist-upgrade"
            - sudo uvt-kvm ssh uvt-user-2404 -- "sudo apt-get -y upgrade"
            - sudo uvt-kvm ssh uvt-user-2404 -- "sudo apt-get -y autoremove"
      
      epilogue:
        always:
          commands:
            # Always destroy VM regardless of job success/failure
            - sudo uvt-kvm destroy uvt-user-2404 || true
